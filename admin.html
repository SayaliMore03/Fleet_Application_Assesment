// Global array to store all vehicle data
let vehicleFleet = [];

const container = document.getElementById('fleetCardsContainer');
const form = document.getElementById('fleetForm');

// --- 1. Vehicle Card Management Functions ---

/**
 * Creates an HTML card element for a single vehicle.
 * @param {object} vehicle - The vehicle data object.
 * @returns {HTMLElement} The dynamically created card element.
 */
function createVehicleCard(vehicle) {
    const card = document.createElement('div');
    card.className = 'vehicle-card';
    card.dataset.regNo = vehicle.regNo; // Used for easy identification

    const availabilityClass = vehicle.isAvailable === 'Available' ? 'Available' : 'Unavailable';
    const statusText = vehicle.isAvailable;

    card.innerHTML = `
        <img src="https://example.com/sample_vehicle.jpg" alt="${vehicle.regNo}" 
            onerror="this.onerror=null;this.src='https://via.placeholder.com/300x150?text=Vehicle'">
        <div class="card-details">
            <p><strong>Reg No:</strong> ${vehicle.regNo}</p>
            <p><strong>Category:</strong> ${vehicle.category}</p>
            <p><strong>Driver:</strong> <span id="driverName_${vehicle.regNo}">${vehicle.driverName}</span></p>
            <p><strong>Status:</strong> 
                <span class="status ${availabilityClass}" id="status_${vehicle.regNo}">
                    ${statusText}
                </span>
            </p>
        </div>
        <div class="card-actions">
            <button class="update-btn" data-reg-no="${vehicle.regNo}">Update Driver</button>
            <button class="availability-btn" data-reg-no="${vehicle.regNo}">Change Availability</button>
            <button class="delete-btn" data-reg-no="${vehicle.regNo}">Delete Vehicle</button>
        </div>
    `;

    // Attach event listeners to the new buttons
    card.querySelector('.update-btn').addEventListener('click', handleUpdateDriver);
    card.querySelector('.availability-btn').addEventListener('click', handleChangeAvailability);
    card.querySelector('.delete-btn').addEventListener('click', handleDeleteVehicle);

    return card;
}

/**
 * Clears the container and renders all vehicles from the global array.
 */
function renderCards(fleetToRender = vehicleFleet) {
    container.innerHTML = '';
    fleetToRender.forEach(vehicle => {
        container.appendChild(createVehicleCard(vehicle));
    });
}

// --- 2. Form Submission (Add Fleet) ---

form.addEventListener('submit', function(e) {
    e.preventDefault();

    const newVehicle = {
        regNo: document.getElementById('regNo').value.trim(),
        category: document.getElementById('category').value,
        driverName: document.getElementById('driverName').value.trim(),
        isAvailable: document.getElementById('isAvailable').value 
    };

    // Form Validation: Required fields check
    if (!newVehicle.regNo || !newVehicle.category || !newVehicle.driverName) {
        alert("All fields are required. Please fill them out.");
        return; // Stop execution
    }

    // Append data to global array
    vehicleFleet.push(newVehicle);

    // Re-render UI to include the new card
    renderCards();

    // Clear the form once data is added
    form.reset();
});

// --- 3. Card Actions (Behavior) ---

// Helper function to find and update vehicle data
function findAndUpdateVehicle(regNo, property, value) {
    const vehicle = vehicleFleet.find(v => v.regNo === regNo);
    if (vehicle) {
        vehicle[property] = value;
    }
}

/** 4.3.1 Update Driver Button */
function handleUpdateDriver(event) {
    const regNo = event.target.dataset.regNo;
    const newDriverName = prompt("Enter new driver name:");

    if (newDriverName === null) {
        // User clicked Cancel on prompt
        return;
    }

    const trimmedName = newDriverName.trim();

    // Empty Driver Name Edge Case
    if (trimmedName === "") {
        alert("Driver name cannot be empty.");
        return;
    }

    // 1. Update Data
    findAndUpdateVehicle(regNo, 'driverName', trimmedName);

    // 2. Update UI (Reflect change immediately)
    const driverNameSpan = document.getElementById(`driverName_${regNo}`);
    if (driverNameSpan) {
        driverNameSpan.textContent = trimmedName;
    }
}

/** 4.3.2 Change Availability Button */
function handleChangeAvailability(event) {
    const regNo = event.target.dataset.regNo;
    const vehicle = vehicleFleet.find(v => v.regNo === regNo);

    if (vehicle) {
        // Determine the new status
        const newStatus = vehicle.isAvailable === 'Available' ? 'Unavailable' : 'Available';
        
        // 1. Update Data
        findAndUpdateVehicle(regNo, 'isAvailable', newStatus);

        // 2. Update UI (Reflect change immediately)
        const statusSpan = document.getElementById(`status_${regNo}`);
        if (statusSpan) {
            statusSpan.textContent = newStatus;
            statusSpan.className = `status ${newStatus}`; // Update class for styling
        }
    }
}

/** 4.3.3 Delete Vehicle Button */
function handleDeleteVehicle(event) {
    const regNo = event.target.dataset.regNo;

    // Delete Confirmation Edge Case
    const isConfirmed = confirm(`Are you sure you want to delete vehicle ${regNo}?`);

    if (isConfirmed) {
        // 1. Remove from Data
        vehicleFleet = vehicleFleet.filter(v => v.regNo !== regNo);

        // 2. Update UI (Remove the card and re-render)
        renderCards(); 
    }
}

// --- 4. Filtering Logic (Navbar) ---

const categoryFilter = document.getElementById('categoryFilter');
const availabilityFilter = document.getElementById('availabilityFilter');
const clearFilterBtn = document.getElementById('clearFilterBtn');

/**
 * Handles filtering the displayed cards based on current selections.
 */
function applyFilters() {
    const selectedCategory = categoryFilter.value;
    const selectedAvailability = availabilityFilter.value;

    const filteredFleet = vehicleFleet.filter(vehicle => {
        const categoryMatch = selectedCategory === 'All' || vehicle.category === selectedCategory;
        const availabilityMatch = selectedAvailability === 'All' || vehicle.isAvailable === selectedAvailability;
        
        // Combine filters: Must match BOTH selected criteria
        return categoryMatch && availabilityMatch; 
    });

    renderCards(filteredFleet);
}

// Attach filter listeners
categoryFilter.addEventListener('change', applyFilters);
availabilityFilter.addEventListener('change', applyFilters);

/**
 * Resets all filters and re-renders all original data.
 */
clearFilterBtn.addEventListener('click', function() {
    // Reset filters to default
    categoryFilter.value = 'All';
    availabilityFilter.value = 'All';
    
    // Re-render and show all original data
    renderCards();
});

// Initial rendering of cards (in case data was loaded from storage, though not required here)
// renderCards(); 

// OPTIONAL: Add some initial dummy data for testing
vehicleFleet.push({ regNo: 'MH01AB1234', category: 'Car', driverName: 'Ramesh', isAvailable: 'Available' });
vehicleFleet.push({ regNo: 'DL99XZ0001', category: 'Truck', driverName: 'Suresh', isAvailable: 'Unavailable' });
vehicleFleet.push({ regNo: 'KA05BA9876', category: 'Bus', driverName: 'Deepa', isAvailable: 'Available' });
renderCards();
